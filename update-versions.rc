echo "Starting Publish to NuGet"

# List of project files in the required order
projects=(
  "KitCli.Abstractions/KitCli.Abstractions.csproj"
  "KitCli.Instructions.Abstractions/KitCli.Instructions.Abstractions.csproj"
  "KitCli.Commands.Abstractions/KitCli.Commands.Abstractions.csproj"
  "KitCli.Instructions/KitCli.Instructions.csproj"
  "KitCli.Commands/KitCli.Commands.csproj"
  "KitCli.Workflow.Abstractions/KitCli.Workflow.Abstractions.csproj"
  "KitCli.Workflow.Commands/KitCli.Workflow.Commands.csproj"
  "KitCli.Workflow/KitCli.Workflow.csproj"
  "KitCli/KitCli.csproj"
)

for proj in "${projects[@]}"; do
  if [[ -f "$proj" ]]; then
    awk '
      BEGIN { in_pg=0 }
      /<PropertyGroup>/ { in_pg=1 }
      /<\/PropertyGroup>/ { in_pg=0 }
      {
        if (in_pg && match($0, /<Version>[0-9]+\.[0-9]+\.[0-9]+<\/Version>/)) {
          ver_start = index($0, "<Version>") + 9
          ver_end = index($0, "</Version>") - 1
          ver = substr($0, ver_start, ver_end - ver_start + 1)
          n = split(ver, parts, ".")
          if (n == 3) {
            parts[3] = parts[3] + 1
            new_ver = parts[1] "." parts[2] "." parts[3]
            sub(/<Version>[0-9]+\.[0-9]+\.[0-9]+<\/Version>/, "<Version>" new_ver "</Version>")
          }
        }
        print $0
      }
    ' "$proj" > "$proj.tmp" && mv "$proj.tmp" "$proj"
    echo "Updated $proj <Version> in <PropertyGroup> (if present)"
  else
    echo "File not found: $proj"
  fi
done